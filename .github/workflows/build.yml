name: CI/CD build

permissions:
  actions: write
  contents: read

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Log in to GitHub Container Registry
        run: |
          if [ -n "${{ secrets.GHCR_PAT }}" ]; then
            echo "Login in to GHCR..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          else
            echo "GHCR_PAT not set; skipping GHCR login."
          fi

      - name: Get remote digest
        id: remote_digest
        run: |
          set -e
          if docker pull ghcr.io/${{ github.repository }}/sample-app:latest 2>/dev/null; then
            digest=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/${{ github.repository }}/sample-app:latest | cut -d'@' -f2)
            echo "digest=$digest" >> $GITHUB_OUTPUT
          else
            echo "digest=" >> $GITHUB_OUTPUT
          fi

      - name: Build local image (no push)
        run: |
          docker build -t local-sample-app:latest .

      - name: Get local digest
        id: local_digest
        run: |
          digest=$(docker inspect --format='{{index .RepoDigests 0}}' local-sample-app:latest | cut -d'@' -f2)
          echo "digest=$digest" >> $GITHUB_OUTPUT

      - name: Compare digests    # Dockerfileの変更を検出するためリモートとローカルのdigestsイメージを比較する
        id: compare
        run: |
          if [ "${{ steps.remote_digest.outputs.digest }}" = "${{ steps.local_digest.outputs.digest }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        if: steps.compare.outputs.changed == 'true' && env.GHCR_PAT != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          pull: true
          tags: |
            ghcr.io/${{ github.repository }}/sample-app:latest
            ghcr.io/${{ github.repository }}/sample-app:sha-${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/sample-app:cache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/sample-app:cache,mode=max

      - name: Build
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            ghcr.io/${{ github.repository }}/sample-app:latest \
            bash -c "mkdir -p build && cd build && cmake .. && make -j$(nproc)"

      - name: Make artifact name
        id: make_name
        run: |
          short=${GITHUB_SHA::8}
          echo "short=$short" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release_${{ steps.make_name.short }}
          path: build/ConvCsvJson

